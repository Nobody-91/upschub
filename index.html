<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPSC Hub</title>
    <link rel="shortcut icon" href="Image/exam-time.png" type="image/x-icon">
    <!-- Use Indigo and Sky for a clean, academic, and interactive look -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
        }
        .sidebar-link {
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        .sidebar-link.active {
            background-color: #4f46e5; /* Indigo 600 */
            color: #ffffff;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            padding: 0 1.5rem; /* Padding for when open, transition handles 0 */
        }
        .accordion-content.open {
            max-height: 3000px; /* Large enough for smooth expansion */
            transition: max-height 0.6s ease-in;
            padding: 1rem 1.5rem;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        /* Timer specific styles */
        #timer-display {
            font-family: monospace;
            font-size: 5rem;
            letter-spacing: -2px;
            color: #1e3a8a; /* Blue 800 */
        }
        
        /* Mobile Sidebar Overrides */
        @media (max-width: 1024px) {
            #sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 75%; /* Max width on mobile */
                height: 100vh;
                z-index: 50; /* Above main content */
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            #sidebar.open {
                transform: translateX(0);
            }
            #mobile-backdrop {
                position: fixed;
                inset: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 40;
            }
            #main-content {
                padding-top: 5rem; /* Space for fixed header */
            }
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div id="app" class="min-h-screen lg:flex">
        
        <!-- Mobile Header (Visible only below lg breakpoint) -->
        <header class="lg:hidden fixed top-0 left-0 right-0 bg-slate-800 text-white p-4 flex items-center justify-between z-20 shadow-lg">
            <h1 class="text-xl font-extrabold tracking-wide">UPSC Hub</h1>
            <button id="menu-toggle" class="p-2 rounded-lg hover:bg-slate-700 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </header>

        <!-- Mobile Backdrop (Hidden by default) -->
        <div id="mobile-backdrop" class="hidden lg:hidden"></div>

        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="lg:w-64 bg-slate-800 lg:flex-shrink-0 lg:h-screen lg:sticky top-0 z-10 p-4">
            <div class="hidden lg:block">
                <h1 class="text-3xl font-extrabold text-white pt-2 pb-6 tracking-wide">UPSC Hub</h1>
                <h6 class="font-extrabold text-white pt-2 pb-6 tracking-wide">by Sholin Saji</h6>
            </div>
            <div class="lg:hidden text-right">
                 <!-- Close button for mobile menu -->
                 <button id="close-menu" class="p-2 mb-4 rounded-lg hover:bg-slate-700 transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <nav id="main-nav">
                <ul class="space-y-1 lg:space-y-2">
                    <li><a href="#schedule" data-page="schedule" class="sidebar-link active block rounded-xl px-4 py-3 text-sm text-slate-300 hover:bg-slate-700">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        200-Day Schedule
                    </a></li>
                    <li><a href="#syllabus" data-page="syllabus" class="sidebar-link block rounded-xl px-4 py-3 text-sm text-slate-300 hover:bg-slate-700">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.206 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.832 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.832 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.168 18 16.5 18s-3.332.477-4.5 1.253"></path></svg>
                        Syllabus Explorer
                    </a></li>
                    <li><a href="#tools" data-page="tools" class="sidebar-link block rounded-xl px-4 py-3 text-sm text-slate-300 hover:bg-slate-700">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Preparation Tools
                    </a></li>
                    <li><a href="#timer" data-page="timer" class="sidebar-link block rounded-xl px-4 py-3 text-sm text-slate-300 hover:bg-slate-700">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Stopwatch / Timer
                    </a></li>
                    <li><a href="#notes" data-page="notes" class="sidebar-link block rounded-xl px-4 py-3 text-sm text-slate-300 hover:bg-slate-700">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.586a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        Persistent Notes
                    </a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 p-6 lg:p-10">
            <div id="content-container">
                <!-- Dynamic page content will be injected here -->
            </div>
            
            <!-- Hidden Modals and UI Elements -->
            <div id="loading-overlay" class="fixed inset-0 bg-slate-500 bg-opacity-30 flex items-center justify-center hidden z-50">
                <div class="card p-6 text-slate-700 font-semibold flex items-center shadow-2xl">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Processing Request...
                </div>
            </div>
            <div id="message-box" class="fixed bottom-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-xl hidden transition-opacity duration-300 z-50"></div>
        </main>
    </div>

<!-- Firebase and App Logic -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global Variables from Canvas
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const apiKey = ""; // API Key for Gemini is left blank
    
    // Global Firebase Instances
    let app, db, auth, userId = null;
    let isAuthReady = false;

    // --- UTILITY FUNCTIONS ---
    function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
    function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
    
    function showMessage(message, type = 'success', duration = 3000) {
        const box = document.getElementById('message-box');
        box.textContent = message;
        box.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-xl transition-opacity duration-300 z-50 text-white`;
        
        switch (type) {
            case 'success':
                box.classList.add('bg-green-500');
                break;
            case 'error':
                box.classList.add('bg-red-600');
                break;
            case 'info':
                box.classList.add('bg-blue-500');
                break;
        }

        box.classList.remove('hidden');
        setTimeout(() => box.classList.add('opacity-0'), duration);
        setTimeout(() => box.classList.add('hidden'), duration + 300);
        box.classList.remove('opacity-0');
    }
    
    // Debounce function to limit function calls (used for saving notes)
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // --- FIREBASE INITIALIZATION & AUTH ---
    function initFirebase() {
        try {
            // setLogLevel('debug'); // Uncomment for debugging
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    // Initial content render after auth is ready
                    renderContent('schedule'); 
                } else {
                    if (authToken) {
                        await signInWithCustomToken(auth, authToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                }
            });

        } catch (e) {
            console.error("Firebase initialization failed:", e);
            showMessage("Firebase failed to initialize. Notes won't be saved.", 'error', 5000);
        }
    }
    
    // Function to generate the complete 200-day plan
    function generateFullStudyPlan() {
        const allDays = [];
        
        // --- Phase 1: Foundation (Days 1–50) ---
        // Focus: Polity, Ancient/Medieval History, Physical/World Geography
        for (let i = 1; i <= 50; i++) {
            let s1, s2;
            if (i <= 3) {
                // Days 1-3 (Polity Core)
                const polityTopics = ["Fundamental Rights (Art. 12–35)", "DPSP (Art. 36–51) & Comparison", "Fundamental Duties + Amendment Procedure"];
                const historyTopics = ["Indus Valley Civilization", "Vedic Age (Early & Later)", "Mahajanapadas, Buddhism & Jainism"];
                s1 = `Polity: ${polityTopics[i - 1]}`;
                s2 = `History: ${historyTopics[i - 1]}`;
            } else if (i <= 7) {
                // Days 4-7 (Polity Executive & Revision)
                const polityTopics = ["President, VP, Electoral College", "Prime Minister & Council of Ministers", "Central Secretariat & Cabinet Committees", "REVISION (Polity Ch. 1-15)"];
                s1 = `Polity: ${polityTopics[i - 4]}`;
                s2 = i === 7 ? "Full Subject Test (Polity + History)" : `History: ${["Mauryan Empire & Ashoka's Dhamma", "Post-Mauryan Kingdoms", "Early Medieval India (Tripartite Struggle)"][i - 4]}`;
            } else if (i <= 14) {
                // Days 8-14 (Polity Parliament & SC)
                const s1Topics = ["Parliament: Sessions, Functioning", "Parliament: Committees & Tools", "Supreme Court: Jurisdiction & Powers", "High Courts & Subordinate Courts", "Center-State Relations (Legislative)", "Inter-State Relations (Council, Water)", "REVISION (Polity + Medieval History)"];
                s1 = `Polity: ${s1Topics[i - 8]}`;
                s2 = i === 14 ? "Prelims Mock (75 Questions)" : `History: ${["Chola Administration & Art", "Delhi Sultanate: Administration & Decline", "Vijayanagara & Bahmani Kingdoms", "Bhakti & Sufi Movements", "Mughal Empire: Akbar to Aurangzeb"][i - 8]}`;
            } else if (i <= 20) {
                // Days 15-20 (Geography Start)
                const geoTopics = ["Internal Structure of Earth", "Plate Tectonics, Earthquakes, Volcanism", "Rocks, Landforms (Erosional)", "Atmosphere: Composition, Insolation", "Atmosphere: Pressure Belts, Winds", "Oceans: Relief, Temperature, Salinity"];
                s1 = `Geography: ${geoTopics[i - 15]}`;
                s2 = i % 7 === 6 ? "Current Affairs: Social Issues" : `Current Affairs: ${["Science & Tech News", "Economy News", "Polity/IR News", "Environment News", "Social Issues News", "REVISION & Short Notes"][i % 7]}`;
            } else {
                // Days 21-50 (General Phase 1 Continuation)
                s1 = `Polity/History: Revision/Mains Practice`;
                s2 = `Geography: Climate, Oceanography, Resources`;
                if (i % 7 === 0) {
                    s1 = "Weekly Revision & Answer Writing";
                    s2 = "Prelims Mock (100 Questions)";
                }
            }
            allDays.push({ day: i, s1: s1, s2: s2 });
        }

        // --- Phase 2: Consolidation (Days 51–100) ---
        // Focus: Modern History, Indian Geography, Economy (Basic), Ethics
        for (let i = 51; i <= 100; i++) {
            let s1, s2;
            if (i <= 70) {
                s1 = `Modern History: Freedom Struggle (1857 to 1947)`;
                s2 = `Indian Geography: Physiography, Climate & Agriculture`;
            } else if (i <= 90) {
                s1 = `Economy: Macro Concepts, Money, Banking (Rajan & Datt)`;
                s2 = `GS IV: Ethics & Values (Lecs 1-5) + Case Study Practice`;
            } else {
                s1 = `Social Justice: Welfare Schemes, Health & Education Sector`;
                s2 = `Governance: Accountability, Transparency, Citizen Charters`;
            }
            
            if (i % 7 === 0 || i === 100) {
                s1 = "REVISION & Mains Answer Writing (GS1/GS2)";
                s2 = "Full Mock Test: Economy & History";
            }
            allDays.push({ day: i, s1: s1, s2: s2 });
        }

        // --- Phase 3: Dynamic & Specialization (Days 101–150) ---
        // Focus: S&T, IR, Security, Optional Paper I
        for (let i = 101; i <= 150; i++) {
            let s1, s2;
            if (i <= 125) {
                s1 = `Optional Paper I: Core Concepts & Theories`;
                s2 = `Science & Technology: Space, Defence, Biotechnology`;
            } else {
                s1 = `IR & Security: Bilateral Ties (India-US, China), Internal Security Challenges`;
                s2 = `Optional Paper I: Applied Concepts & Previous Year Qs`;
            }
            
            if (i % 7 === 0 || i === 150) {
                s1 = "Optional P1 Revision & Essay Practice";
                s2 = "Current Affairs Monthly Compilation Review";
            }
            allDays.push({ day: i, s1: s1, s2: s2 });
        }

        // --- Phase 4: Mains Practice & Revision (Days 151–190) ---
        // Focus: Optional Paper II, Intensive Answer Writing, GS Revision
        for (let i = 151; i <= 189; i++) {
            let s1, s2;
            if (i <= 170) {
                s1 = `Optional Paper II: Complete Coverage (Lecs/Reading)`;
                s2 = `Mains Practice: GS3 Qs (Economy, Security, Disaster Mgmt)`;
            } else {
                s1 = `GS Revision: GS1 & GS2 Final Notes Review`;
                s2 = `Optional P2: Intensive Answer Writing & Models`;
            }
            
            if (i % 7 === 0) {
                s1 = "Full Mains Mock (GS 1 or GS 2)";
                s2 = "Review and Model Answer Creation";
            }
            allDays.push({ day: i, s1: s1, s2: s2 });
        }
        
        // --- Phase 5: Grand Finale (Days 190–200) - Using Specific Plan ---
        const finalDaysDetails = [
            { day: 190, s1: "Optional Subject", s2: "Optional Subject Test II + Review (8 Hrs)" },
            { day: 191, s1: "GS Revision", s2: "GS3 & GS4 Key Notes Review (8 Hrs)" },
            { day: 192, s1: "Essay Practice", s2: "Write 1 Essay + Review Structure & Flow (8 Hrs)" },
            { day: 193, s1: "Mains Practice", s2: "GS1/GS2/GS3 Mixed Practice Test + Review (8 Hrs)" },
            { day: 194, s1: "Revision", s2: "Revise All GS Paper Key Notes (1–4) (8 Hrs)" },
            { day: 195, s1: "Essay", s2: "Essay Writing Final Practice (2 Essays) + Review (8 Hrs)" },
            { day: 196, s1: "GS", s2: "Rapid Revision – GS1 + GS2 (8 Hrs)" },
            { day: 197, s1: "GS", s2: "Rapid Revision – GS3 + GS4 (8 Hrs)" },
            { day: 198, s1: "Optional", s2: "Final Summary Notes (Both Papers) + Maps/Diagrams Review (8 Hrs)" },
            { day: 199, s1: "Comprehensive", s2: "Mock Test – Full Mains Simulation (GS1–4 + Essay) (8 Hrs)" },
            { day: 200, s1: "Rest & Prep", s2: "Final Review of Strategy & Important Facts (6 Hrs)" },
        ];
        
        // Push the final 11 days (190-200)
        finalDaysDetails.forEach(d => {
            if (d.day >= 190 && d.day <= 200) {
                // Replace the generic day 190, and add the rest
                if (d.day === 190) {
                     allDays[allDays.length - 1] = d; // Overwrite the last day of Phase 4 (Day 189) if it was generated
                } else {
                    allDays.push(d);
                }
            }
        });
        
        // Ensure 200 days total (the loop for 151-189 generated 39 days, plus 50+50+50 = 150. Total 189. Add 11 final days = 200.)
        if (allDays.length > 200) {
            allDays.splice(200); // Trim if necessary
        }


        // Group into Weeks
        const detailedWeeks = [];
        for (let i = 0; i < 200; i += 7) {
            const weekNumber = Math.floor(i / 7) + 1;
            const weekDays = allDays.slice(i, i + 7);
            
            let goal;
            if (weekNumber <= 7) goal = "Core foundation in Polity, Ancient/Medieval History, and Physical Geography.";
            else if (weekNumber <= 14) goal = "Modern History, Indian Geography, and Economy (Basic).";
            else if (weekNumber <= 21) goal = "Dynamic subjects (S&T, IR, Security) and Optional Paper I foundation.";
            else if (weekNumber <= 27) goal = "Mains Answer Writing, Optional Paper II, and GS Revision.";
            else goal = "Grand Finale: Final Revision, Mock Tests, and Essay Practice.";


            detailedWeeks.push({
                week: weekNumber,
                goal: goal,
                days: weekDays
            });
        }

        return detailedWeeks;
    }

    const completeDetailedWeeks = generateFullStudyPlan();


    // --- CORE DATA (Consolidated and Structured) ---
    const studyPlanData = {
        title: "Detailed 200-Day Study Schedule",
        intro: "This schedule is broken down into thematic phases, combining static subjects with dynamic components (Current Affairs, Optional). Click on any Phase to view the detailed weekly focus. This structure aims for foundational completion followed by intensive practice and revision.",
        phases: [
            { phase: 1, title: "Phase 1: Foundation (Days 1–50)", summary: "Core coverage of **Polity (Laxmikanth)**, **Ancient/Medieval History**, and **Physical Geography**." },
            { phase: 2, title: "Phase 2: Consolidation (Days 51–100)", summary: "Focus on **Modern History (Post 1857)**, **Indian Geography**, and **Economy (Basic Concepts)**. Initial **Ethics**." },
            { phase: 3, title: "Phase 3: Dynamic & Specialization (Days 101–150)", summary: "**Science & Tech**, **IR**, **Security**, **Social Justice**, and deep dive into **Optional Subject Paper I**." },
            { phase: 4, title: "Phase 4: Mains Practice & Revision (Days 151–190)", summary: "Intensive **Answer Writing**, Full **Optional Subject Paper II**, and **GS Revision (GS1 & GS2)**." },
            { phase: 5, title: "Phase 5: Grand Finale (Days 191–200)", summary: "Final **Rapid Revision** of all notes, **Full-Length Mock Tests**, and **Essay Writing** practice." }
        ],
        // Use the generated complete plan
        detailedWeeks: completeDetailedWeeks 
    };
    
    // Detailed Syllabus Data for Syllabus Explorer Page
    const syllabusData = {
        gs1: {
            title: "GS Paper I: History, Society, and Geography",
            intro: "Indian Heritage and Culture, History and Geography of the World and Society. Focus is primarily on static concepts for both Prelims (P) and Mains (M).",
            topics: [
                { sub: "Indian Culture", details: "Art Forms, Literature, and Architecture from ancient to modern times.", focusP: "Specific sites, terms (Viharas, Chaityas), schools of philosophy.", focusM: "Socio-religious context of art, impact of Bhakti/Sufi." },
                { sub: "Modern History", details: "From mid-18th century until the present, including the Freedom Struggle.", focusP: "Acts, personalities, INC sessions, chronological events.", focusM: "Causes/consequences, contributions of individuals/groups." }
            ]
        },
        gs2: {
            title: "GS Paper II: Polity, Governance, and IR",
            intro: "Constitution, Governance, Social Justice, and International Relations. This section links heavily with current administrative issues and constitutional precedents.",
            topics: [
                { sub: "Constitution & Polity", details: "Basic structure, FR, DPSP, Union and State machinery, Federalism.", focusP: "Articles, Amendments, powers of President/Governor.", focusM: "Judicial Review, Separation of Powers, challenges to federalism." },
                { sub: "Governance & Social Justice", details: "Welfare schemes, accountability, Civil Services, role of NGOs/SHGs, health, education.", focusP: "Specific commissions (e.g., NCW, SC/ST).", focusM: "Policy implementation challenges, e-Governance, citizen charters." }
            ]
        },
        gs3: {
            title: "GS Paper III: Economy, S&T, Environment, and Security",
            intro: "Technology, Economic Development, Biodiversity, Environment, Security and Disaster Management. Highly integrated with current affairs and recent reports.",
            topics: [
                { sub: "Indian Economy", details: "Planning, Budgeting, Investment models, Agriculture, Infrastructure.", focusP: "RBI tools, Fiscal/Revenue deficit, MSP, crop patterns.", focusM: "Impact of subsidies, financial market reforms, land reforms." },
                { sub: "Internal Security", details: "Linkages to extremism, Cyber Security, Border Management, Money Laundering.", focusP: "N/A (Primarily Mains).", focusM: "Challenges of non-state actors, multi-agency coordination, cybersecurity framework." }
            ]
        },
        gs4: {
            title: "GS Paper IV: Ethics, Integrity, and Aptitude",
            intro: "Ethics and Human Interface, Attitude, Aptitude, Emotional Intelligence, Probity in Governance, and Case Studies. Requires analytical application.",
            topics: [
                { sub: "Theoretical Concepts", details: "Ethics & values, Attitude, Emotional Intelligence, Foundational values for Civil Service.", focusP: "N/A (Primarily Mains).", focusM: "Defining and applying values (integrity, impartiality), ethical dilemmas, conflict of interest." },
                { sub: "Case Studies", details: "Application of all theoretical concepts to real-life administrative scenarios.", focusP: "N/A (Primarily Mains).", focusM: "Systematic approach (Stakeholders, Options, Justification), ethical theories (Deontology, Consequentialism)." }
            ]
        },
    };

    // --- PAGE CONTENT GENERATION FUNCTIONS ---

    // 1. SCHEDULE PAGE CONTENT
    function createScheduleContent() {
        // Detailed Day-by-Day View (Example Week 1)
        const detailedView = studyPlanData.detailedWeeks.map(week => `
            <div class="card p-6 mb-6">
                <h3 class="text-xl font-bold text-indigo-700 mb-2">📅 Week ${week.week} (Days ${week.days[0].day}–${week.days[week.days.length - 1].day})</h3>
                <p class="text-sm text-slate-600 mb-4">Goal: ${week.goal}</p>
                <div class="space-y-4">
                    ${week.days.map(day => `
                        <div class="bg-indigo-50 p-4 rounded-lg border-l-4 border-indigo-500 flex flex-col sm:flex-row justify-between">
                            <span class="font-semibold text-slate-900 w-full sm:w-1/6">Day ${day.day}</span>
                            <span class="text-sm text-slate-700 w-full sm:w-5/12 border-t sm:border-t-0 sm:border-r border-indigo-200 pr-2 pt-1 sm:pt-0">${day.s1}</span>
                            <span class="text-sm text-slate-700 w-full sm:w-5/12 pt-1 sm:pt-0">${day.s2}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');

        // Phase Overview (using collapsible cards)
        const phaseOverview = studyPlanData.phases.map(p => `
            <div class="card mb-4 overflow-hidden">
                <button class="phase-header w-full text-left p-5 bg-indigo-50 hover:bg-indigo-100 flex justify-between items-center transition rounded-t-xl" data-phase="${p.phase}">
                    <h3 class="text-lg font-bold text-indigo-800">${p.title}</h3>
                    <span class="text-sm font-medium text-slate-600 hidden sm:block w-1/3">${p.summary}</span>
                    <svg class="w-5 h-5 text-indigo-800 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div class="phase-content accordion-content text-slate-700">
                    <p class="mb-4 font-semibold">${p.summary.replace(/\*\*/g, '')}</p>
                    <p class="text-sm text-slate-500">The detailed daily tasks for this phase are provided below in the full 200-day schedule.</p>
                </div>
            </div>
        `).join('');

        return `
            <h2 class="text-4xl font-extrabold text-slate-900 mb-4">${studyPlanData.title}</h2>
            <p class="text-lg text-slate-600 mb-8">${studyPlanData.intro}</p>

            <h3 class="text-2xl font-bold text-slate-800 mb-4">Phase Overview</h3>
            ${phaseOverview}

            <h3 class="text-2xl font-bold text-slate-800 mt-10 mb-4">Full 200-Day Daily Schedule</h3>
            ${detailedView}
        `;
    }

    // 2. SYLLABUS PAGE CONTENT
    function createSyllabusContent() {
        const sections = Object.keys(syllabusData).map(key => {
            const paper = syllabusData[key];
            const topics = paper.topics.map(t => `
                <div class="p-4 bg-slate-50 rounded-lg border-l-4 border-sky-500 mb-3">
                    <h4 class="font-semibold text-slate-800">${t.sub}</h4>
                    <p class="text-sm text-slate-600 mt-1">${t.details}</p>
                    <div class="mt-2 text-xs">
                        <p class="font-medium text-indigo-700">P Focus: ${t.focusP}</p>
                        <p class="font-medium text-red-700">M Focus: ${t.focusM}</p>
                    </div>
                </div>
            `).join('');
            
            return `
                <div class="card mb-6 overflow-hidden">
                    <button class="accordion-header w-full text-left p-5 bg-sky-100 hover:bg-sky-200 flex justify-between items-center transition rounded-t-xl">
                        <h3 class="text-xl font-bold text-sky-800">${paper.title}</h3>
                        <svg class="w-5 h-5 text-sky-800 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="accordion-content text-slate-700 space-y-4">
                        <p class="text-md font-medium text-slate-700">${paper.intro}</p>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            ${topics}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        return `
            <h2 class="text-4xl font-extrabold text-slate-900 mb-4">UPSC Syllabus Explorer</h2>
            <p class="text-lg text-slate-600 mb-8">Access detailed, topic-wise syllabus breakdown for all four General Studies papers. Click on a paper to expand the key focus areas for Prelims (P) and Mains (M).</p>
            ${sections}
        `;
    }
    
    // 3. TOOLS PAGE CONTENT (With Gemini API Integration)
    function createToolsContent() {
        return `
            <h2 class="text-4xl font-extrabold text-slate-900 mb-4">Preparation Tools</h2>
            <p class="text-lg text-slate-600 mb-8">Tools designed to accelerate your dynamic preparation, from current affairs research to conceptual analysis.</p>

            <!-- Current Affairs Generator Card -->
            <div class="card p-6 mb-8">
                <h3 class="text-2xl font-bold text-indigo-700 mb-4">📰 Current Affairs Generator (Gemini Grounded Search)</h3>
                <p class="text-slate-600 mb-4">Search for the latest news on a UPSC-relevant topic and get a concise, exam-focused summary using live information.</p>
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                    <input type="text" id="ca-query" placeholder="e.g., Impact of recent budget on MSME sector" class="flex-grow p-3 border border-slate-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
                    <button id="ca-generate-btn" class="bg-sky-600 text-white font-semibold p-3 rounded-lg hover:bg-sky-700 transition">Search & Summarize</button>
                </div>
                
                <div id="ca-result" class="mt-6 border-t border-slate-200 pt-4 hidden">
                    <h4 class="text-xl font-bold text-slate-900 mb-2">Summary:</h4>
                    <div id="ca-summary" class="p-4 bg-slate-50 rounded-lg text-slate-700 whitespace-pre-wrap"></div>
                    <div id="ca-sources" class="mt-4 text-xs text-slate-500"></div>
                </div>
            </div>

            <!-- Future Tools Placeholder -->
            <div class="card p-6">
                <h3 class="text-2xl font-bold text-indigo-700 mb-4">📚 Quick Reference Library</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="p-4 bg-gray-100 rounded-lg text-slate-600">Economic Survey Key Takeaways</div>
                    <div class="p-4 bg-gray-100 rounded-lg text-slate-600">Important Constitutional Articles List</div>
                    <div class="p-4 bg-gray-100 rounded-lg text-slate-600">UN Agencies & Headquarters</div>
                </div>
                <p class="mt-4 text-sm text-slate-500">Future feature: Clickable cards with essential revision facts.</p>
            </div>
        `;
    }
    
    // 4. TIMER PAGE CONTENT
    function createTimerContent() {
        return `
            <h2 class="text-4xl font-extrabold text-slate-900 mb-4">Study Timer & Productivity Clock</h2>
            <p class="text-lg text-slate-600 mb-8">Use the timer to manage your study sessions effectively. Choose between a standard **Stopwatch** or the focused **Pomodoro** technique.</p>

            <div class="card p-8 max-w-lg mx-auto text-center">
                <div class="mb-6 flex justify-center space-x-4">
                    <button id="mode-stopwatch" class="p-3 rounded-full font-semibold text-white bg-indigo-500 hover:bg-indigo-600 transition shadow-md">Stopwatch Mode</button>
                    <button id="mode-pomodoro" class="p-3 rounded-full font-semibold text-indigo-500 bg-indigo-100 hover:bg-indigo-200 transition shadow-md">Pomodoro Mode</button>
                </div>

                <div id="timer-display" class="font-mono mb-8">00:00:00</div>
                <p id="timer-status" class="text-lg font-semibold text-green-600 mb-6 hidden"></p>

                <div id="stopwatch-controls" class="space-x-4">
                    <button id="start-stopwatch" class="w-24 p-3 rounded-lg text-white bg-green-600 hover:bg-green-700 font-semibold transition">Start</button>
                    <button id="pause-stopwatch" class="w-24 p-3 rounded-lg text-white bg-yellow-600 hover:bg-yellow-700 font-semibold transition" disabled>Pause</button>
                    <button id="reset-stopwatch" class="w-24 p-3 rounded-lg text-white bg-red-600 hover:bg-red-700 font-semibold transition">Reset</button>
                </div>

                <div id="pomodoro-controls" class="space-y-4 hidden">
                    <div class="flex justify-center space-x-4 mb-4">
                        <button id="pomo-study" data-time="25" class="p-3 rounded-lg text-white bg-sky-600 hover:bg-sky-700 font-semibold transition shadow-md">25 Min Study</button>
                        <button id="pomo-break" data-time="5" class="p-3 rounded-lg text-sky-600 bg-sky-100 hover:bg-sky-200 font-semibold transition shadow-md">5 Min Break</button>
                    </div>
                    <div class="space-x-4">
                        <button id="start-pomodoro" class="w-24 p-3 rounded-lg text-white bg-green-600 hover:bg-green-700 font-semibold transition">Start</button>
                        <button id="stop-pomodoro" class="w-24 p-3 rounded-lg text-white bg-red-600 hover:bg-red-700 font-semibold transition">Stop</button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // 5. NOTES PAGE CONTENT
    function createNotesContent() {
        return `
            <h2 class="text-4xl font-extrabold text-slate-900 mb-4">Persistent Study Notes</h2>
            <p class="text-lg text-slate-600 mb-8">A personal notebook powered by Firestore. Your notes are saved automatically as you type.</p>

            <div class="card p-6">
                <textarea id="study-notes" class="w-full h-96 p-4 border border-slate-300 rounded-lg text-lg focus:ring-indigo-500 focus:border-indigo-500 resize-none outline-none" placeholder="Start typing your key revision points, analysis, and facts here. Notes are saved automatically every few seconds."></textarea>
                <p class="mt-3 text-sm text-slate-500 flex justify-between">
                    <span>Note ID: <span id="note-user-id" class="font-mono text-xs bg-slate-200 p-1 rounded">Loading...</span></span>
                    <span id="save-status" class="text-indigo-600 font-medium">Ready</span>
                </p>
            </div>
        `;
    }

    // --- RENDER LOGIC ---
    const contentContainer = document.getElementById('content-container');
    const navLinks = document.querySelectorAll('.sidebar-link');
    const sidebar = document.getElementById('sidebar');
    const backdrop = document.getElementById('mobile-backdrop');

    // Function to handle opening and closing the sidebar on mobile
    function toggleSidebar(open) {
        // Only run on mobile (window width <= 1024px)
        if (window.innerWidth >= 1024) return;

        if (open) {
            sidebar.classList.add('open');
            backdrop.classList.remove('hidden');
        } else {
            sidebar.classList.remove('open');
            backdrop.classList.add('hidden');
        }
    }

    function renderContent(pageKey) {
        showLoading();
        let contentHtml = '';
        let setupFunction = null;
        
        // Auto-hide the sidebar on mobile when a link is clicked
        toggleSidebar(false);

        // Clear existing interval/listeners for clean page switch
        if (window.activeInterval) { clearInterval(window.activeInterval); }

        switch (pageKey) {
            case 'schedule':
                contentHtml = createScheduleContent();
                setupFunction = setupSchedulePage;
                break;
            case 'syllabus':
                contentHtml = createSyllabusContent();
                setupFunction = setupSyllabusPage;
                break;
            case 'tools':
                contentHtml = createToolsContent();
                setupFunction = setupToolsPage;
                break;
            case 'timer':
                contentHtml = createTimerContent();
                setupFunction = setupTimerPage;
                break;
            case 'notes':
                contentHtml = createNotesContent();
                setupFunction = setupNotesPage;
                break;
            default:
                contentHtml = `<h2 class="text-3xl text-red-500">Page Not Found</h2>`;
        }

        contentContainer.innerHTML = contentHtml;
        // Run setup function after content is in the DOM
        if (setupFunction) {
            // Wait for next tick to ensure DOM is updated
            setTimeout(setupFunction, 0); 
        }
        hideLoading();
    }

    // --- PAGE SETUP FUNCTIONS (Listeners and Logic) ---

    // 1. SCHEDULE PAGE SETUP
    function setupSchedulePage() {
        document.querySelectorAll('.phase-header').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                const icon = header.querySelector('svg');
                content.classList.toggle('open');
                icon.classList.toggle('rotate-180');
            });
        });
    }

    // 2. SYLLABUS PAGE SETUP
    function setupSyllabusPage() {
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                const icon = header.querySelector('svg');
                content.classList.toggle('open');
                icon.classList.toggle('rotate-180');
            });
        });
    }
    
    // 3. TOOLS PAGE SETUP (Current Affairs Generator Logic)
    async function fetchGeminiContent(userQuery) {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        
        const systemPrompt = "Act as a UPSC expert. Given the user's query about a current affairs topic, use Google Search to find relevant, up-to-date information, and provide a concise, exam-focused summary suitable for Mains or Prelims. The summary must be a single, detailed paragraph.";

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            tools: [{ "google_search": {} }], // Enable grounding
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        const caResult = document.getElementById('ca-result');
        const caSummary = document.getElementById('ca-summary');
        const caSources = document.getElementById('ca-sources');
        caResult.classList.add('hidden');
        caSummary.textContent = 'Searching and summarizing...';
        caSources.textContent = '';
        caResult.classList.remove('hidden');
        
        showLoading();

        try {
            // Exponential backoff logic for fetch call
            const maxRetries = 3;
            let response = null;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) break;
                    if (i === maxRetries - 1) throw new Error(`API error after ${maxRetries} retries: ${response.statusText}`);
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); // Exponential backoff
                } catch (e) {
                    if (i === maxRetries - 1) throw e;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }


            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const text = candidate.content.parts[0].text;
                caSummary.textContent = text;

                let sourcesHtml = 'Sources: ';
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    const sources = groundingMetadata.groundingAttributions
                        .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title }))
                        .filter(source => source.uri && source.title)
                        .slice(0, 3); // Limit to top 3 sources

                    sourcesHtml += sources.map(s => `<a href="${s.uri}" target="_blank" class="text-sky-600 hover:underline">${s.title}</a>`).join(', ');
                } else {
                    sourcesHtml += 'No specific sources cited.';
                }
                caSources.innerHTML = sourcesHtml;
                
            } else {
                caSummary.textContent = 'Could not generate a summary. Please try a different query.';
                caSources.textContent = '';
            }

        } catch (error) {
            console.error('Gemini API call failed:', error);
            caSummary.textContent = 'An error occurred while connecting to the AI tool. Please check the console for details.';
            caSources.textContent = '';
            showMessage('Current Affairs tool failed.', 'error');
        } finally {
            hideLoading();
        }
    }

    function setupToolsPage() {
        document.getElementById('ca-generate-btn').addEventListener('click', () => {
            const query = document.getElementById('ca-query').value.trim();
            if (query.length > 5) {
                fetchGeminiContent(query);
            } else {
                showMessage('Please enter a longer, more specific query.', 'info');
            }
        });
    }

    // 4. TIMER PAGE SETUP (Stopwatch/Pomodoro Logic)
    let timerInterval = null;
    let totalSeconds = 0;
    let isRunning = false;
    let isPomodoroMode = false;
    let pomodoroState = 'Study'; // 'Study' or 'Break'

    function formatTime(sec) {
        const hours = String(Math.floor(sec / 3600)).padStart(2, '0');
        const minutes = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
        const seconds = String(sec % 60).padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
    }

    function updateTimerDisplay() {
        document.getElementById('timer-display').textContent = formatTime(totalSeconds);
    }
    
    function updateStatus(status, color = 'text-green-600') {
        const statusEl = document.getElementById('timer-status');
        statusEl.textContent = status;
        statusEl.className = `text-lg font-semibold mb-6 ${color}`;
        statusEl.classList.remove('hidden');
    }

    function startTimer() {
        if (isRunning) return;
        isRunning = true;
        if (!isPomodoroMode) {
             updateStatus('Stopwatch Running...', 'text-green-600');
             document.getElementById('pause-stopwatch').disabled = false;
             document.getElementById('start-stopwatch').disabled = true;
        }
       
        window.activeInterval = setInterval(() => {
            totalSeconds = isPomodoroMode ? totalSeconds - 1 : totalSeconds + 1;
            updateTimerDisplay();

            if (isPomodoroMode && totalSeconds <= 0) {
                clearInterval(window.activeInterval);
                isRunning = false;
                
                // Switch Pomodoro state
                if (pomodoroState === 'Study') {
                    pomodoroState = 'Break';
                    totalSeconds = 5 * 60; // 5 min break
                    updateStatus('Time for a 5-minute BREAK!', 'text-sky-600');
                    showMessage('Take a break!', 'info', 5000);
                } else {
                    pomodoroState = 'Study';
                    totalSeconds = 25 * 60; // 25 min study
                    updateStatus('Time to STUDY (25 mins)!', 'text-green-600');
                    showMessage('Back to studying!', 'info', 5000);
                }
                updateTimerDisplay();
                // Since this is a self-contained app, we won't auto-start to give the user control
            }
        }, 1000);
    }
    
    function stopTimer() {
        clearInterval(window.activeInterval);
        isRunning = false;
        if (!isPomodoroMode) {
            updateStatus('Stopwatch Paused.', 'text-yellow-600');
            document.getElementById('pause-stopwatch').disabled = true;
            document.getElementById('start-stopwatch').disabled = false;
        } else {
            updateStatus(`${pomodoroState} Paused.`, 'text-yellow-600');
        }
    }
    
    function resetTimer() {
        stopTimer();
        totalSeconds = 0;
        updateTimerDisplay();
        document.getElementById('timer-status').classList.add('hidden');
        if (!isPomodoroMode) {
             document.getElementById('pause-stopwatch').disabled = true;
             document.getElementById('start-stopwatch').disabled = false;
        }
    }

    function setPomodoroTime(minutes) {
        stopTimer();
        totalSeconds = minutes * 60;
        updateTimerDisplay();
        
        if (minutes === 25) {
            pomodoroState = 'Study';
            updateStatus('Ready for a 25-minute Study Session.', 'text-green-600');
        } else {
            pomodoroState = 'Break';
            updateStatus('Ready for a 5-minute Break.', 'text-sky-600');
        }
    }
    
    function switchMode(isPomo) {
        stopTimer();
        isPomodoroMode = isPomo;
        totalSeconds = isPomo ? (25 * 60) : 0; // Default to 25 min study for Pomo
        updateTimerDisplay();
        document.getElementById('timer-status').classList.add('hidden');

        document.getElementById('stopwatch-controls').classList.toggle('hidden', isPomo);
        document.getElementById('pomodoro-controls').classList.toggle('hidden', !isPomo);
        
        // Update button styles
        document.getElementById('mode-stopwatch').classList.toggle('bg-indigo-500', !isPomo);
        document.getElementById('mode-stopwatch').classList.toggle('text-white', !isPomo);
        document.getElementById('mode-stopwatch').classList.toggle('bg-indigo-100', isPomo);
        document.getElementById('mode-stopwatch').classList.toggle('text-indigo-500', isPomo);

        document.getElementById('mode-pomodoro').classList.toggle('bg-indigo-500', isPomo);
        document.getElementById('mode-pomodoro').classList.toggle('text-white', isPomo);
        document.getElementById('mode-pomodoro').classList.toggle('bg-indigo-100', !isPomo);
        document.getElementById('mode-pomodoro').classList.toggle('text-indigo-500', !isPomo);
        
        // Reset button states for stopwatch mode
        if (!isPomo) {
            document.getElementById('pause-stopwatch').disabled = true;
            document.getElementById('start-stopwatch').disabled = false;
        }
    }


    function setupTimerPage() {
        // Init to Stopwatch mode
        switchMode(false); 
        
        document.getElementById('mode-stopwatch').addEventListener('click', () => switchMode(false));
        document.getElementById('mode-pomodoro').addEventListener('click', () => switchMode(true));

        // Stopwatch Controls
        document.getElementById('start-stopwatch').addEventListener('click', startTimer);
        document.getElementById('pause-stopwatch').addEventListener('click', stopTimer);
        document.getElementById('reset-stopwatch').addEventListener('click', resetTimer);

        // Pomodoro Controls
        document.getElementById('pomo-study').addEventListener('click', () => setPomodoroTime(25));
        document.getElementById('pomo-break').addEventListener('click', () => setPomodoroTime(5));
        document.getElementById('start-pomodoro').addEventListener('click', startTimer);
        document.getElementById('stop-pomodoro').addEventListener('click', stopTimer);
    }
    
    // 5. NOTES PAGE SETUP (Firestore Logic)
    let saveNoteDebounced = null;
    const NOTE_DOC_ID = 'user_study_notes';

    /**
     * Constructs the correct Firestore document reference path for private user data.
     * Path MUST have an even number of segments (collection/document/collection/document...).
     * /artifacts/{appId}/users/{userId}/private/data/{NOTE_DOC_ID}
     */
    function getNoteDocRef() {
        if (!db || !userId) return null;
        // The path structure is: collection/document/collection/document/collection/document (6 segments)
        return doc(db, `artifacts/${appId}/users/${userId}/private/data`, NOTE_DOC_ID);
    }

    async function loadNotes() {
        if (!isAuthReady || !db || !userId) return;

        const docRef = getNoteDocRef();
        if (!docRef) return;
        
        // Listen for real-time changes
        onSnapshot(docRef, (docSnap) => {
            const notesEl = document.getElementById('study-notes');
            if (docSnap.exists() && notesEl) {
                const data = docSnap.data();
                if (data.content !== notesEl.value) {
                    notesEl.value = data.content || "";
                }
                document.getElementById('save-status').textContent = 'Loaded from Cloud';
            } else {
                if (notesEl) notesEl.value = "Welcome! Start typing your notes here. They will be saved automatically.";
                document.getElementById('save-status').textContent = 'Ready';
            }
        }, (error) => {
            console.error("Error listening to document:", error);
            showMessage("Error loading notes: Check console.", 'error');
        });
    }

    async function saveNotes(content) {
        if (!isAuthReady || !db || !userId) {
            console.warn("Attempted to save notes before auth was ready.");
            return;
        }
        document.getElementById('save-status').textContent = 'Saving...';
        
        const docRef = getNoteDocRef();
        if (!docRef) return;

        try {
            await setDoc(docRef, {
                content: content,
                updatedAt: new Date()
            }, { merge: true });
            document.getElementById('save-status').textContent = 'Saved!';
        } catch (e) {
            console.error("Error saving document: ", e);
            document.getElementById('save-status').textContent = 'Save Failed!';
        }
    }

    function setupNotesPage() {
        // Display User ID for reference
        document.getElementById('note-user-id').textContent = userId || "Anon";
        
        // Setup Debounced Save function
        saveNoteDebounced = debounce((content) => saveNotes(content), 3000);
        
        const notesEl = document.getElementById('study-notes');
        if (notesEl) {
            notesEl.addEventListener('input', (e) => {
                document.getElementById('save-status').textContent = 'Unsaved changes...';
                saveNoteDebounced(e.target.value);
            });
        }
        
        // Load notes initially (or the onSnapshot listener will handle it)
        loadNotes();
    }


    // --- MAIN NAVIGATION AND INITIALIZATION ---
    
    // Mobile menu handlers
    document.getElementById('menu-toggle').addEventListener('click', () => toggleSidebar(true));
    document.getElementById('close-menu').addEventListener('click', () => toggleSidebar(false));
    document.getElementById('mobile-backdrop').addEventListener('click', () => toggleSidebar(false));

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const pageKey = link.getAttribute('data-page');

            // Update Active Link State
            navLinks.forEach(nav => nav.classList.remove('active'));
            link.classList.add('active');

            // Hide menu on click for mobile users
            toggleSidebar(false); 

            renderContent(pageKey);
        });
    });

    // Start Firebase Initialization
    initFirebase();
    
    // Auth Listener handles the initial call to renderContent('schedule')

</script>
</body>
</html>
